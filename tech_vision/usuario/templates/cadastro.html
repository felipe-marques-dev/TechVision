
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'usuario/css/style.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Cadastre-se</title>
</head>
<body>
    <div class="container-fluid mb-3 w-25 position-absolute top-50 start-50 translate-middle bg-secondary p-4" style="border-radius: 20px;">
        <h1 class="d-flex justify-content-center">Cadastre-se</h1>
        <form id="cadastro-form" method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label for="inputEmail" class="form-label">Email</label><br>
                <input type="email" name="email" id="inputEmail" class="form-control">
                <div id="email-error" class="text-danger"></div>
            </div>
            <div class="mb-3">
                <label for="inputNome" class="form-label">Nome</label><br>
                <input type="text" name="first_name" id="inputNome" class="form-control">
                <div id="nome-error" class="text-danger"></div>
            </div>
            <div class="mb-3">
                <label for="inputSobrenome" class="form-label">Sobrenome</label><br>
                <input type="text" name="last_name" id="inputSobrenome" class="form-control">
                <div id="sobrenome-error" class="text-danger"></div>
            </div>
            <div class="mb-3">
                <label for="inputPassword" class="form-label">Senha</label><br>
                <input type="password" name="password" id="inputPassword" class="form-control">
                <div id="password-error" class="text-danger"></div>
            </div>
            <div class="col-12 d-flex justify-content-center">
                <button type="submit" class="btn btn-dark mt-4" style="border-radius: 10px;">Criar conta</button>
            </div>
        </form>
    </div>

    <script>
      // .ready espera o carregamento do DOM para iniciar a funcao
      // $() seleciona elementos do DOM
      // document representa a pagina web
      $(document).ready(function() {
          // envia o formulario com base no evento de submit (ouvinte)       
          $('#cadastro-form').on('submit', function(e) { // $() seleciona elemento do #cadastro-form, e represnta o objeto evento
              e.preventDefault(); // previne o envio de maneira padrao ( recarrega a pagina)
              
              $.ajax({ // funcao do jQuery para envio de solicitacao AJAX
                  type: 'POST', 
                  url: '{% url "cadastro" %}',  // url da view atual do Django
                  data: $(this).serialize(),  // converte os dados do formulario para uma string url codificada
                  dataType: 'json',   // espera resposta JSON do servidor
                  success: function(response) { // funcao q sera executada em caso de solicitacao bem sucedida
                      $('.text-danger').empty();
  
                       if(response.success == false) {
                          // verifica se errors eh uma string JSON e a analisa
                          let errors = response.errors;
                          if (typeof errors === 'string') {
                              errors = JSON.parse(errors); // converte para objeto JSON
                              console.log(errors) 
                          }
  
                          // atualiza os campos de erro com base na resposta
                          // each itera sobre cada item em um objeto ou array
                          $.each(errors, function(field, messages) { // field pode ser email ou senha nesse caso, e messages sao os erros
                              var errorField = '#' + field + '-error';  // cria um seletor no qual vai ser representado o erro (id da div)
                              // seleciona o elemento html com o seletor errorField, 
                              // e retorna um novo array( messages ) usando a funcao map(),
                              // com apenas as mensagens do objeto JSON (message),
                              // .join() une tudo em uma so string separando as mensagens por <br>
                              $(errorField).html(messages.map(msg => msg.message).join('<br>'));  
                          });
                      }
                      else{
                        window.location.href = response.redirect_url;
                      }
                  },
                  // funcao em caso de erro de solicitacao, retorna status, obj da requisicao, e o erro
                  error: function(xhr, status, error) {
                      console.log('Erro:', error);
                  }
              });
          });
      });
  </script>  
</body>
</html>